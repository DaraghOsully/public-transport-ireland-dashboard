<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Irish Public Transportation – Malaysia‑style Dashboard</title>
  <!-- Load React and ReactDOM from CDN for a simple single page app -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* General page styling */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
        Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f8ff;
      color: #333;
      line-height: 1.4;
    }
    /* Hero section */
    .hero {
      background: linear-gradient(135deg, #e0f7fa, #e0f2f1);
      padding: 2rem 1rem;
      text-align: center;
    }
    .hero h1 {
      margin: 0;
      font-size: 2rem;
    }
    .hero p {
      margin: 1rem auto;
      max-width: 600px;
      font-size: 1rem;
      color: #444;
    }
    /* Update information */
    .update-info {
      text-align: center;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 1rem;
    }
    /* Metrics cards */
    .metrics-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin: 0 1rem 2rem;
    }
    .metric-card {
      flex: 1 1 120px;
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    .metric-value {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .metric-label {
      font-size: 0.85rem;
      color: #555;
      margin-top: 0.25rem;
    }
    /* View toggle buttons */
    .view-toggle {
      text-align: center;
      margin-bottom: 1rem;
    }
    .view-toggle button {
      margin: 0 0.25rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e0e0e0;
      color: #333;
    }
    .view-toggle button.active {
      background: #00695c;
      color: #fff;
    }
    /* Chart containers */
    .chart-container,
    .services-chart-container {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin: 0 1rem 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    /* Services metrics */
    .services-metrics-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 0 1rem 2rem;
    }
    .service-metric-card {
      flex: 1 1 140px;
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .service-metric-card h3 {
      margin: 0 0 0.5rem;
      font-size: 1rem;
    }
    .service-metric-values span {
      display: block;
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 0.25rem;
    }
    /* Mode gallery for images */
    .mode-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 1rem;
    }
    .mode-gallery figure {
      margin: 0;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .mode-gallery img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }
    .mode-gallery figcaption {
      padding: 0.5rem;
      font-size: 0.75rem;
      color: #555;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <!-- Main script defining React components and logic -->
  <script>
    // Helper: convert ISO week (year, week) to a Date object (Monday of that week)
    function isoWeekToDate(year, week) {
      // Create a date representing the first day of the year
      const simple = new Date(year, 0, 1 + (week - 1) * 7);
      const dow = simple.getDay();
      // 0 is Sunday, so adjust to Monday (1)
      const ISOweekStart = new Date(simple);
      if (dow <= 4) {
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
      } else {
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
      }
      return ISOweekStart;
    }

    // Main React component
    function App() {
      const { useState, useEffect, useRef } = React;
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [rows, setRows] = useState([]);
      const [view, setView] = useState('weekly'); // 'weekly' or 'yearly'
      const [aggAllWeekly, setAggAllWeekly] = useState([]);
      const [aggAllYearly, setAggAllYearly] = useState([]);
      const [weeklyByMode, setWeeklyByMode] = useState({});
      const [yearlyByMode, setYearlyByMode] = useState({});
      const [metricsAll, setMetricsAll] = useState({ latest: 0, weeklyTrend: 0, monthlyTrend: 0 });
      const [metricsByMode, setMetricsByMode] = useState({});
      const [updateInfo, setUpdateInfo] = useState({ lastUpdate: '', nextUpdate: '', dataAsOf: '' });
      const aggChartRef = useRef(null);
      const servicesChartRef = useRef(null);

      // Load CSV on mount
      useEffect(() => {
        async function load() {
          try {
            // Fetch both THA25 and TII03 datasets.  THA25 contains bus and rail data,
            // while TII03 provides weekly Luas passenger numbers.  Both files are
            // stored in this repository as CSVs.
            const [thaRes, tiiRes] = await Promise.all([
              fetch('THA25.csv'),
              fetch('TII03.csv'),
            ]);
            if (!thaRes.ok) throw new Error('Failed to fetch THA25.csv');
            if (!tiiRes.ok) throw new Error('Failed to fetch TII03.csv');
            const [thaCsv, tiiCsv] = await Promise.all([
              thaRes.text(),
              tiiRes.text(),
            ]);
            const thaParsed = Papa.parse(thaCsv, { header: true, skipEmptyLines: true });
            const tiiParsed = Papa.parse(tiiCsv, { header: true, skipEmptyLines: true });
            const mapped = [];
            // Process THA25 rows
            thaParsed.data.forEach(row => {
              const modeLabel = row['Mode of Transport'] || row['C03935V04687'] || '';
              const value = row['VALUE'];
              if (!value || value === '') return;
              const val = parseInt(value, 10);
              const weekCode = row['TLIST(W1)'];
              if (!weekCode) return;
              const year = parseInt(weekCode.slice(0, 4), 10);
              const wkMatch = weekCode.match(/W(\d+)/i);
              const week = wkMatch ? parseInt(wkMatch[1], 10) : 1;
              const lower = modeLabel.toLowerCase();
              // Skip aggregate categories such as "all public transport"
              if (lower.includes('all')) return;
              let mode;
              if (lower.includes('metro')) {
                mode = 'Dublin Bus';
              } else if (lower.includes('bus') && lower.includes('excluding')) {
                mode = 'Regional Bus';
              } else if (lower.includes('rail')) {
                mode = 'Irish Rail';
              } else {
                // skip unknown categories and Luas (handled separately)
                return;
              }
              mapped.push({ mode, year, week, value: val });
            });
            // Process TII03 rows (Luas)
            tiiParsed.data.forEach(row => {
              // Only use the aggregate of all Luas lines
              const line = row['Luas Line'] || row['C03132V03784'];
              if (!line || line.toLowerCase().indexOf('all') === -1) return;
              const value = row['VALUE'];
              if (!value || value === '') return;
              const val = parseInt(value, 10);
              const weekCode = row['TLIST(W1)'] || row['Week'];
              if (!weekCode) return;
              const year = parseInt(weekCode.slice(0, 4), 10);
              const wkMatch = weekCode.match(/W(\d+)/i);
              const week = wkMatch ? parseInt(wkMatch[1], 10) : 1;
              mapped.push({ mode: 'Luas', year, week, value: val });
            });
            setRows(mapped);
            setLoading(false);
          } catch (err) {
            console.error(err);
            setError(err.message || 'Unknown error');
            setLoading(false);
          }
        }
        load();
      }, []);

      // Compute aggregations and metrics when rows loaded
      useEffect(() => {
        if (!rows.length) return;
        // Group by (year, week) across all modes for aggregated weekly
        const weekMap = {};
        rows.forEach(r => {
          const key = `${r.year}-${r.week}`;
          if (!weekMap[key]) weekMap[key] = 0;
          weekMap[key] += r.value;
        });
        const aggWeekly = Object.keys(weekMap)
          .map(key => {
            const [year, week] = key.split('-').map(n => parseInt(n, 10));
            return { year, week, value: weekMap[key] };
          })
          .sort((a, b) => a.year - b.year || a.week - b.week);
        setAggAllWeekly(aggWeekly);
        // Group by year for aggregated yearly
        const yearMap = {};
        aggWeekly.forEach(item => {
          if (!yearMap[item.year]) yearMap[item.year] = 0;
          yearMap[item.year] += item.value;
        });
        const aggYearly = Object.keys(yearMap)
          .map(y => ({ year: parseInt(y, 10), value: yearMap[y] }))
          .sort((a, b) => a.year - b.year);
        setAggAllYearly(aggYearly);
        // Group by mode
        const byModeMap = {};
        rows.forEach(r => {
          const key = `${r.year}-${r.week}`;
          if (!byModeMap[r.mode]) byModeMap[r.mode] = {};
          if (!byModeMap[r.mode][key]) byModeMap[r.mode][key] = 0;
          byModeMap[r.mode][key] += r.value;
        });
        const weeklyBy = {};
        Object.keys(byModeMap).forEach(mode => {
          const arr = Object.keys(byModeMap[mode])
            .map(key => {
              const [year, week] = key.split('-').map(n => parseInt(n, 10));
              return { year, week, value: byModeMap[mode][key] };
            })
            .sort((a, b) => a.year - b.year || a.week - b.week);
          weeklyBy[mode] = arr;
        });
        setWeeklyByMode(weeklyBy);
        // Yearly by mode
        const yearlyBy = {};
        Object.keys(weeklyBy).forEach(mode => {
          const yearMapMode = {};
          weeklyBy[mode].forEach(item => {
            if (!yearMapMode[item.year]) yearMapMode[item.year] = 0;
            yearMapMode[item.year] += item.value;
          });
          yearlyBy[mode] = Object.keys(yearMapMode)
            .map(y => ({ year: parseInt(y, 10), value: yearMapMode[y] }))
            .sort((a, b) => a.year - b.year);
        });
        setYearlyByMode(yearlyBy);
        // Compute metrics for aggregated weekly
        function computeMetrics(dataArr) {
          const n = dataArr.length;
          if (n === 0) return { latest: 0, weeklyTrend: 0, monthlyTrend: 0 };
          const latest = dataArr[n - 1].value;
          const prev = n > 1 ? dataArr[n - 2].value : latest;
          const weeklyTrend = prev === 0 ? 0 : ((latest - prev) / prev) * 100;
          // monthly: last 4 weeks vs previous 4 weeks
          const last4 = dataArr.slice(-4);
          const sumLast4 = last4.reduce((s, d) => s + d.value, 0);
          const prev4 = dataArr.slice(-8, -4);
          const sumPrev4 = prev4.reduce((s, d) => s + d.value, 0);
          const monthlyTrend = sumPrev4 === 0 ? 0 : ((sumLast4 - sumPrev4) / sumPrev4) * 100;
          return { latest, weeklyTrend, monthlyTrend };
        }
        // Aggregated metrics
        setMetricsAll(computeMetrics(aggWeekly));
        // Metrics by mode
        const mByMode = {};
        Object.keys(weeklyBy).forEach(mode => {
          mByMode[mode] = computeMetrics(weeklyBy[mode]);
        });
        // Also include an aggregated category for all public transport
        // using the same weekly aggregate used for overall metrics
        mByMode['All Public Transport'] = computeMetrics(aggWeekly);
        setMetricsByMode(mByMode);
        // Compute update dates
        const lastItem = aggWeekly[aggWeekly.length - 1];
        if (lastItem) {
          const lastDate = isoWeekToDate(lastItem.year, lastItem.week);
          const endDate = new Date(lastDate);
          endDate.setDate(endDate.getDate() + 6); // end of week (Sunday)
          const nextDate = new Date(endDate);
          nextDate.setDate(nextDate.getDate() + 7);
          const format = (d) =>
            d.toLocaleDateString('en-GB', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            });
          const lastUpdateStr = format(endDate) + ', 12:00';
          const nextUpdateStr = format(nextDate) + ', 12:00';
          const dataAsOf = format(endDate) + ', 23:59';
          setUpdateInfo({ lastUpdate: lastUpdateStr, nextUpdate: nextUpdateStr, dataAsOf });
        }
      }, [rows]);

      // Draw aggregated chart
      useEffect(() => {
        if (!aggAllWeekly.length) return;
        const labels = view === 'weekly'
          ? aggAllWeekly.map(item => `${item.year}W${String(item.week).padStart(2, '0')}`)
          : aggAllYearly.map(item => `${item.year}`);
        const dataVals = view === 'weekly'
          ? aggAllWeekly.map(item => item.value)
          : aggAllYearly.map(item => item.value);
        const ctx = document.getElementById('aggChart').getContext('2d');
        if (aggChartRef.current) aggChartRef.current.destroy();
        aggChartRef.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'All Public Transport',
                data: dataVals,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { display: true, title: { display: false } },
              y: { beginAtZero: true },
            },
            plugins: { legend: { display: true, position: 'top' } },
          },
        });
      }, [aggAllWeekly, aggAllYearly, view]);

      // Draw services (by mode) chart
      useEffect(() => {
        const modes = Object.keys(weeklyByMode);
        if (modes.length === 0) return;
        let labels;
        if (view === 'weekly') {
          labels = aggAllWeekly.map(item => `${item.year}W${String(item.week).padStart(2, '0')}`);
        } else {
          labels = aggAllYearly.map(item => `${item.year}`);
        }
        const datasets = modes.map(mode => {
          let data;
          if (view === 'weekly') {
            // Create a map for quick lookup
            const map = {};
            weeklyByMode[mode].forEach(item => {
              map[`${item.year}-${item.week}`] = item.value;
            });
            data = aggAllWeekly.map(item => map[`${item.year}-${item.week}`] || 0);
          } else {
            const map = {};
            yearlyByMode[mode].forEach(item => {
              map[item.year] = item.value;
            });
            data = aggAllYearly.map(item => map[item.year] || 0);
          }
          return {
            label: mode,
            data,
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 0,
          };
        });
        const ctx = document.getElementById('servicesChart').getContext('2d');
        if (servicesChartRef.current) servicesChartRef.current.destroy();
        servicesChartRef.current = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { display: true, title: { display: false } },
              y: { beginAtZero: true },
            },
            plugins: { legend: { display: true, position: 'top' } },
          },
        });
      }, [weeklyByMode, yearlyByMode, aggAllWeekly, aggAllYearly, view]);

      if (loading) {
        return React.createElement('div', { style: { padding: '2rem', textAlign: 'center' } }, 'Loading data...');
      }
      if (error) {
        return React.createElement('div', { style: { padding: '2rem', color: 'red', textAlign: 'center' } }, `Error: ${error}`);
      }

      // Render metrics for each service mode
      const serviceCards = Object.keys(metricsByMode).map(mode => {
        const m = metricsByMode[mode];
        const trendWeek = m.weeklyTrend.toFixed(1) + '%';
        const trendMonth = m.monthlyTrend.toFixed(1) + '%';
        return React.createElement(
          'div',
          { className: 'service-metric-card', key: mode },
          React.createElement('h3', null, mode),
          React.createElement('div', { className: 'service-metric-values' }, [
            React.createElement('span', { key: 'latest' }, `Latest: ${m.latest.toLocaleString()}`),
            React.createElement('span', { key: 'week' }, `Trend (weekly): ${trendWeek}`),
            React.createElement('span', { key: 'month' }, `Trend (4w): ${trendMonth}`),
          ])
        );
      });

      // Build the page structure using React.createElement
      return React.createElement(
        React.Fragment,
        null,
        // Hero section
        React.createElement(
          'section',
          { className: 'hero' },
          React.createElement('h1', null, 'Irish Public Transportation Dashboard'),
          React.createElement(
            'p',
            null,
            'Drawing on high‑frequency data from operators of Ireland\'s public transportation services, this dashboard brings you the latest trends in public transport ridership.'
          )
        ),
        // Update info
        React.createElement(
          'div',
          { className: 'update-info' },
          `Last updated: ${updateInfo.lastUpdate} | Next update: ${updateInfo.nextUpdate} | Data as of ${updateInfo.dataAsOf}`
        ),
        // Metrics for aggregated all services
        React.createElement(
          'div',
          { className: 'metrics-container' },
          [
            React.createElement(
              'div',
              { className: 'metric-card', key: 'latest' },
              React.createElement('div', { className: 'metric-value' }, metricsAll.latest.toLocaleString()),
              React.createElement('div', { className: 'metric-label' }, 'Latest Week')
            ),
            React.createElement(
              'div',
              { className: 'metric-card', key: 'weekTrend' },
              React.createElement('div', { className: 'metric-value' },
                (metricsAll.weeklyTrend >= 0 ? '+' : '') + metricsAll.weeklyTrend.toFixed(1) + '%'
              ),
              React.createElement('div', { className: 'metric-label' }, 'Trend (weekly)')
            ),
            React.createElement(
              'div',
              { className: 'metric-card', key: 'monthTrend' },
              React.createElement('div', { className: 'metric-value' },
                (metricsAll.monthlyTrend >= 0 ? '+' : '') + metricsAll.monthlyTrend.toFixed(1) + '%'
              ),
              React.createElement('div', { className: 'metric-label' }, 'Trend (4w)')
            ),
          ]
        ),
        // View toggle
        React.createElement(
          'div',
          { className: 'view-toggle' },
          [
            React.createElement(
              'button',
              {
                key: 'weekly',
                className: view === 'weekly' ? 'active' : '',
                onClick: () => setView('weekly'),
              },
              'Weekly'
            ),
            React.createElement(
              'button',
              {
                key: 'yearly',
                className: view === 'yearly' ? 'active' : '',
                onClick: () => setView('yearly'),
              },
              'Yearly'
            ),
          ]
        ),
        // Aggregated chart
        React.createElement(
          'div',
          { className: 'chart-container' },
          React.createElement('h2', null, 'Ridership Trend – All Public Transport'),
          React.createElement('div', { style: { height: '300px' } },
            React.createElement('canvas', { id: 'aggChart' })
          )
        ),
        // Services chart
        React.createElement(
          'div',
          { className: 'services-chart-container' },
          React.createElement('h2', null, 'Ridership Trend by Service'),
          React.createElement('div', { style: { height: '300px' } },
            React.createElement('canvas', { id: 'servicesChart' })
          )
        ),
        // Services metrics cards
        React.createElement(
          'div',
          { className: 'services-metrics-container' },
          serviceCards
        ),
        // Mode gallery with images
        React.createElement(
          'div',
          { className: 'mode-gallery' },
          [
            React.createElement(
              'figure',
              { key: 'dublin-bus' },
              React.createElement('img', { src: 'dublin_bus.jpg', alt: 'Dublin Bus double‑decker' }),
              React.createElement('figcaption', null, 'Dublin Bus – CC BY-SA / Wikimedia Commons')
            ),
            React.createElement(
              'figure',
              { key: 'regional-bus' },
              React.createElement('img', { src: 'bus_eireann.jpg', alt: 'Regional Bus (Bus Éireann) coach' }),
              React.createElement('figcaption', null, 'Regional Bus (Bus Éireann) – CC BY 4.0 / Wikimedia Commons')
            ),
            React.createElement(
              'figure',
              { key: 'luas' },
              React.createElement('img', { src: 'luas_tram.jpg', alt: 'Luas tram on O\'Connell Street' }),
              React.createElement('figcaption', null, 'Luas tram – CC BY 3.0 / Wikimedia Commons')
            ),
            React.createElement(
              'figure',
              { key: 'irish-rail-icr' },
              React.createElement('img', { src: 'intercity_train.jpg', alt: 'Irish Rail InterCity Railcar' }),
              React.createElement('figcaption', null, 'Irish Rail InterCity – CC BY 2.0 / Wikimedia Commons')
            ),
            React.createElement(
              'figure',
              { key: 'irish-rail-dart' },
              React.createElement('img', { src: 'dart_train.jpg', alt: 'DART train at station' }),
              React.createElement('figcaption', null, 'Irish Rail DART – CC BY 4.0 / Wikimedia Commons')
            ),
            React.createElement(
              'figure',
              { key: 'local-link' },
              React.createElement('img', { src: 'local_link_bus.jpg', alt: 'Local Link bus' }),
              React.createElement('figcaption', null, 'Local Link (TFI) – illustrative')
            ),
          ]
        ),
        // Data source note
        React.createElement(
          'p',
          { style: { fontSize: '0.7rem', textAlign: 'center', color: '#777', marginBottom: '2rem' } },
          'Source: CSO THA25 (bus and rail) & TII03 (Luas) datasets'
        )
      );
    }
    // Mount the app
    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(React.createElement(App));
  </script>
</body>
</html>